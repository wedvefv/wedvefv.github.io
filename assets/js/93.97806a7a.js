(window.webpackJsonp=window.webpackJsonp||[]).push([[93],{492:function(s,t,a){"use strict";a.r(t);var n=a(56),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"ngx-lua的三种变量范围"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ngx-lua的三种变量范围"}},[s._v("#")]),s._v(" NGX_LUA的三种变量范围")]),s._v(" "),a("ol",[a("li",[a("p",[s._v("进程间共享， nginx的所有work进程共享，使用lua_shared_dict定义，这样高并发就出触发锁。")])]),s._v(" "),a("li",[a("p",[s._v("进程内共享，lua代码中不加local关键字就是全局变量，这样的变量在同一个进程的所有请求之间共享,因为开启了lua缓存，每个work的VM虚拟机都会缓存全局变量.")])]),s._v(" "),a("li",[a("p",[s._v("同一个请求，比如local声明的或者ngx.ctx")])]),s._v(" "),a("li",[a("p",[s._v("lua_shared_dict 有模块"),a("a",{attrs:{href:"https://github.com/openresty/lua-resty-lrucache",target:"_blank",rel:"noopener noreferrer"}},[s._v("lua-resty-lrucache"),a("OutboundLink")],1),s._v("可以实现在一个work中共享，由于nginx是单进程的，所以永远不会触发锁\n就是兼顾效率而且没有锁的问题，缺点内存比进程间共享占用比较大。")])]),s._v(" "),a("li",[a("p",[s._v("如果在模块文件中，定义了一个函数, 使用到了一个参数未定义，则会认为是nil")])])]),s._v(" "),a("blockquote",[a("p",[s._v("如果这个参数在函数外面且在函数定义之前定义。 比如")])]),s._v(" "),a("div",{staticClass:"language-lua line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-lua"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" x"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("get_val")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("print")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("x"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 10")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("blockquote",[a("p",[s._v("如果在函数之后定义")])]),s._v(" "),a("div",{staticClass:"language-lua line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-lua"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("get_val")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("print")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("x"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- nil")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" x"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("blockquote"),s._v(" "),a("p",[s._v("总结：")]),s._v(" "),a("p",[s._v("也就是模块变量，或者全局变量要在使用之前定义，否则认为是nil。")]),s._v(" "),a("p",[s._v("同样的道理，如果一个函数不是_M.的成员，而是local function定义的模块函数，也需要在调用者的前面定义。")]),s._v(" "),a("p",[s._v("杜绝使用全局变量")])])}),[],!1,null,null,null);t.default=e.exports}}]);