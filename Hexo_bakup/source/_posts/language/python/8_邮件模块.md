---
layout: post
title: flask 第8章（邮件模块）
category: flask
date: 2019-02-13 11:57:00

---



##  安装模块
```py
pip install flask-mail
```

## smtp配置

* smtp 简单邮件传输协议,如果不配置，默认使用localhost主机，25端口，无需验证即可发送邮件
*  如果配置，这使用配置的服务器发送mail

## smtp 配置选项

|配置| 默认值|说明|
|-|-|-|
|MAIL_SERVER|localhost|电子邮件服务器的主机名或ip地址|
|MAIL_PORT|25|电子邮件服务器的端口|
|MAIL_USE_TLS|False|启用传输层安全|
|MAIL_USE_SSL|False|启用安全套接层|
|MAIL_USERNAME|None|邮件账户名|
|MAIL_PASSWORD|None|邮件账户密码|


## 整个hello.py文件

```py
#coding=utf=8
import pymysql
pymysql.install_as_MySQLdb()

import MySQLdb,os
# 引入核心模块和模板加载模块
from flask import Flask, render_template,session,redirect,url_for,flash
# 引入bootstrap前端框架
from flask_bootstrap import Bootstrap
# 引入时间模块,实现了momment.js
from flask_moment import Moment
# 引入manage模块，服务器启动参数控制
from flask_script import Manager
# 引入表单模块
from flask_wtf import FlaskForm
# 引入表单字段类
from wtforms import StringField,SubmitField
# 引入表单验证函数
from wtforms.validators import Required
# 导入数据库包
from flask_sqlalchemy import SQLAlchemy
# 导入数据迁移模块
from flask_migrate import Migrate,MigrateCommand
# 导入mail 模块
from flask_mail import Mail,Message
# 每个web表单都有一个继承自FlaskForm的类表示,所以先定义一个类
class NameForm(FlaskForm):
    name = StringField("what is your name ?",validators=[Required()]) # 字段对象可附加多个验证函数，所以是列表, Required确保非空
    submit = SubmitField("Submit1")


app = Flask(__name__)
# 生成加密令牌的密钥,再用令牌验证请求的表单数据真伪
app.config['SECRET_KEY'] = 'this random string！'

# 数据库配置
app.config["SQLALCHEMY_DATABASE_URI"] = "mysql://appwriter:appwr@zxcv@127.0.0.1/flask1?charset=utf8"
app.config["SQLALCHEMY_COMMIT_ON_TEARDOWN"] = True # 请求结束自动提交数据库变动
app.config["SQLALCHEMY_TRACK_MODIFICATIONS"] = True # 这行不能缺

# MAIL 配置
app.config["MAIL_SERVER"] = 'smtp.qq.com' ## qq邮箱smtp服务器
app.config['MAIL_PORT']= 25
app.config['MAIL_USE_TLS'] = False
app.config['MAIL_USERNAME'] = os.environ.get('MAIL_USERNAME') #qq邮箱
app.config['MAIL_PASSWORD'] = os.environ.get('MAIL_PASSWORD') #qq邮箱客户端登录授权码，相当于密码

app.config['FLASK_MAIL_SUBJECT_PREFIX'] = '[Flasky]'
app.config['FLASK_MAIL_SENDER'] = 'FLASK Admin<%s>' % os.environ.get('MAIL_USERNAME') #发送者
app.config['FLASK_ADMIN'] = os.environ.get("FLASK_ADMIN")
print app.config['FLASK_ADMIN']
#SQLALCHEMY_COMMIT_TEARDOWN = True

db = SQLAlchemy(app) # 数据库实例 模型继承于db.model, 模型在python就是一个类，数据库中是一个表，类属性就是表字段

bootstrap = Bootstrap(app)
moment = Moment(app)
manager = Manager(app)
migrate = Migrate(app, db)
manager.add_command('db',  MigrateCommand)
mail = Mail(app)

# 定义模型
class Role(db.Model):
    __tablename__ = 'roles'
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(64),unique=True)
    users = db.relationship("User", backref='role')

    def __repr__(self):
        return '<Role %r> ' % self.name

class User(db.Model):
    __tablename__ = "users"
    id = db.Column(db.Integer,primary_key=True)
    username = db.Column(db.String(64),unique=True)
    role_id = db.Column(db.Integer, db.ForeignKey('roles.id'))

    
    def __repr__(self):
        return '<User %r> ' % self.username

@app.errorhandler(404)
def page_not_found(e):
    return render_template('404.html'), 404


@app.errorhandler(500)
def internal_server_error(e):
    return render_template('500.html'), 500


@app.route('/1', methods=['GET', 'POST'])
def index1():
    form = NameForm()
    if form.validate_on_submit():
        old_name = session.get("name")
        if old_name is not None and old_name != form.name.data:
            flash("your are changing your name .")
        session["name"] = form.name.data
        return redirect(url_for("index")) # 一般endpoint就是视图函数名
    return render_template("index.html", form=form, name = session.get('name'))
    #return render_template("index.html", form=form, name = None)


@app.route("/", methods=['GET','POST'])
def index():
    form = NameForm()
    if form.validate_on_submit():
        user = User.query.filter_by(username=form.name.data).first()
        if user is None:
            user = User(username=form.name.data)
            db.session.add(user)
            session['known'] = False
        else:
            session['known'] = True
        session['name'] = form.name.data
        form.name.data = ''
        return redirect(url_for("index"))
    return render_template("index.html", form = form, name = session.get("name"), known=session.get('known',False) )


def send_email(to, subject, template, **kwargs):
	msg = Message(app.config['FLASK_MAIL_SUBJECT_PREFIX'] + subject,
	sender=app.config['FLASK_MAIL_SENDER'], recipients=[to])      
	#msg.body = render_template(template + '.txt', **kwargs)
	msg.html = render_template(template + '.html',**kwargs)
	mail.send(msg)
	
@app.route("/mail", methods=['GET','POST'])
def index2():
	print 90
	form = NameForm()
	if form.validate_on_submit():
		user = User.query.filter_by(username=form.name.data).first() # 如果数据库没有这个name，说明是新用户，就给管理员发封邮件。
		#print "2222", user
		if user is None:
			user = User(username=form.name.data)
			db.session.add(user)
			session['known'] = False
			if app.config['FLASK_ADMIN']:
				#print "123",app.config['FLASK_ADMIN']
				send_email(app.config['FLASK_ADMIN'], 'New User', 'mail/new_user',user=user)
		else:
			session['known'] = True
		session['name'] = form.name.data
		form.name.data = ''
		return redirect(url_for('index2'))
	return render_template('index.html',form=form,name=session.get('name'),known=session.get('known',False))



if __name__ == "__main__":
    manager.run()
```

## 邮件模板
```py
	mkdir template/mail
	touch template/mail/new_user.html
	写入邮件模板,用户提交用户名时，向ADMIN发送一封邮件。
	User {{ user.username }} has joined.
	
```


## 需要配置的环境变量
```py
vim /etc/profile
export MAIL_USERNAME='' # 比如qq邮箱账号
export MAIL_PASSWORD='' # 如果是qq邮箱，这里是qq邮箱的客户端授权码，需要短信验证生成
export FLASK_ADMIN='' # 这封邮件的接受者

```






