---
layout: post
title: 微信支付流程
category: 微信支付
date: 2019-04-13 09:40:00
comments: true

---


## 三个平台都有什么？

* 微信公众平台: 微信官方平台，功能： 群发推送、自动回复、二维码订阅，用途：消息推送、品牌传播、分享
* 微信开放平台: 为第三方提供接口，比如分享朋友圈，发送给微信好友等
* 微信商户平台：主要是用于微信支付的，比如APP和公众号需要接入支付功能，就需要申请一个商户号。


## 前提
* 在开放平台，注册自己的app，通俗讲就是在微信备案一下。

## 客户端需要干嘛？

* 需要下载微信安卓或者ios版SDK,集成到自己的app中，主要是为了调起微信支付模块。
* app调起支付模块，需要传参数吧，不然请求微信服务器也不知道具体转给谁钱，转多少钱...
* 支付参数哪里来呢？服务器生成啊.....
* 支付完成后微信会返回微信订单号的信心，后期可以用于到微信服务器查询订单状态。


## 商户服务器需要干嘛，比如一个卖游戏点卡的app？

### 给客户端提供接口
* 1.支付接口，这个接口需要以下业务功能
* > 1.去查询用户是否存在，用户信息可以在redis中记录
* > 2.如果某类商品，用户只能有一个产品生效的,比如点卡A,产品类别id为A
* > 3.使用redis记录uid:goodsid[A]:hash记录这个购买的点卡x的信息,记录createtime，orderid，prepayid
* > 4.如果uid对应点卡A的信息存在，且now - createtime < 15分钟，说明微信没回调过来，是支付中...的状态。直接拿缓存中信息返回给客户端就可以了，供客户端调用支付模块。
* > 5.如果uid对应的点卡信心不存在，就说明用户没买过这种A这类的商品,生成28位的订单号作为out_trade_no参数，其他参数按规定设置，然后调用微信统一下单接口 https://api.mch.weixin.qq.com/pay/unifiedorder
* > 6. 当前商户服务器统一下单的过程中，需要用mysql记录自己的订单信息、更新用户的余额扣减、记录一些用户订购该类产品的缓存信息等；mysql数据用于支付完成后，微信发起异步回调状态时更新订单状态。
* > 7.下单后生成预支付id：prepayid，因为还没有真正调起支付模块，只是微信那边现生成一个预支付回话id。
* > 8.有了prepayid加上其他参数，返回给客户端用于真正调起sdk支付模块。
* > 9.调完支付模块后，微信服务器会立刻返回到app中，这时候客户端需要实现onResp回调函数，如果支付成功，需要去服务器查询是否真的ok，永远以服务端返回的支付结果为准。

* 2.主动查询订单接口
* > 1.需要知道我们自己分配的订单orderid，和uid，从mysql获取缓存，校验orderid和uid是不是对应同一个人。
* > 2.查到mysql记录的这个订单状态还是支付中，就用orderid，微信推荐优先使用微信订单号，如果这个字段缺少就用商户的订单号。
* > 3.调起微信查询url https://api.mch.weixin.qq.com/pay/orderquery，判断返回结果，然后事务操作（更新mysql订单状态，及用户金钱信息余额等）。


* 回调接口（给微信服务器使用，用于回调支付状态）
* > 1.我们首先查询订单状态是否为1支付中的状态，如果不是，说明失败，或者成功了，不与理会
* > 2.如果数据return_code或者result_code不全是SUCCESS，直接按对应格式返回成功
* > 3.如果都是SUCCESS，校验WXPAY_SECKEY，APPID，MCHID。
* > 4.都通过了,则事务操作（更新mysql订单状态，及用户金钱信息余额等）,修改必要的缓存。



