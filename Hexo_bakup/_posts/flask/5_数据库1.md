---
layout: post
title: flask 第5章(数据库操作)
category: flask
date: 2019-01-28 22:22:00

---


# 数据库操作

## 1. 安装需要的包

* pip install flask-sqlalchemy


hello.py

```py
#coding=utf=8
import pymysql
pymysql.install_as_MySQLdb()

import MySQLdb # MySQLdb 只支持python2 ,我这limitlinux转不上，只能装pymysql代替，但是需要上面2行代码

# 引入核心模块和模板加载模块
from flask import Flask, render_template,session,redirect,url_for,flash
# 引入bootstrap前端框架
from flask_bootstrap import Bootstrap
# 引入时间模块,实现了momment.js
from flask_moment import Moment
# 引入manage模块，服务器启动参数控制
from flask_script import Manager
# 引入表单模块
from flask_wtf import FlaskForm
# 引入表单字段类
from wtforms import StringField,SubmitField
# 引入表单验证函数
from wtforms.validators import Required
#导入数据库包
from flask_sqlalchemy import SQLAlchemy

# 每个web表单都有一个继承自FlaskForm的类表示,所以先定义一个类
class NameForm(FlaskForm):
    name = StringField("what is your name ?",validators=[Required()]) # 字段对象可附加多个验证函数，所以是列表, Required确保非空
    submit = SubmitField("Submit1")


app = Flask(__name__)
# 生成加密令牌的密钥,再用令牌验证请求的表单数据真伪
app.config['SECRET_KEY'] = 'this random string！'

# 数据库配置
app.config["SQLALCHEMY_DATABASE_URI"] = "mysql://appwriter:appwr@zxcv@192.168.43.186/flask?charset=utf8"
app.config["SQLALCHEMY_COMMIT_ON_TEARDOWN"] = True # 请求结束自动提交数据库变动
app.config["SQLALCHEMY_TRACK_MODIFICATIONS"] = True # 这行不能缺
#SQLALCHEMY_COMMIT_TEARDOWN = True

db = SQLAlchemy(app) # 数据库实例 模型继承于db.model, 模型在python就是一个类，数据库中是一个表，类属性就是表字段

bootstrap = Bootstrap(app)
moment = Moment(app)
manager = Manager(app)


# 定义模型
class Role(db.Model):
    __tablename__ = 'roles'
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(64),unique=True)
    users = db.relationship("User", backref='role')

    def __repr__(self):
        return '<Role %r> ' % self.name

class User(db.Model):
    __tablename__ = "users"
    id = db.Column(db.Integer,primary_key=True)
    username = db.Column(db.String(64),unique=True)
    role_id = db.Column(db.Integer, db.ForeignKey('roles.id'))

    
    def __repr__(self):
        return '<User %r> ' % self.username

@app.errorhandler(404)
def page_not_found(e):
    return render_template('404.html'), 404


@app.errorhandler(500)
def internal_server_error(e):
    return render_template('500.html'), 500


@app.route('/', methods=['GET', 'POST'])
def index():
    form = NameForm()
    if form.validate_on_submit():
        old_name = session.get("name")
        if old_name is not None and old_name != form.name.data:
            flash("your are changing your name .")
        session["name"] = form.name.data
        return redirect(url_for("index")) # 一般endpoint就是视图函数名
    return render_template("index.html", form=form, name = session.get('name'))
    #return render_template("index.html", form=form, name = None)

if __name__ == "__main__":
    manager.run()

```


## 2. SQLAlchemy 常用的列类型

|类型名|python类型|说明|
|-|-|-|
|Integer|int|普通整数一般32位|
|Smallinteger|int|一般16位的整数|
|BigInteger|int|不限制精度的整数|
|Float|float|浮点数|
|Numeric|decimal.Decimal|定点数，小数|
|String|str|字符串|
|Text|str|较长的字符串，做了优化，或不限制长度|
|Unicode|unicode|变长unicode字符串，对不限长度的字符串做了优化|
|Boolean|bool|布尔值|
|Date|datetime.date|日期|
|Time|datetime.time|时间|
|DateTime|datetime.datetime|日期和时间|
|Interval|datetime.timedelta|时间间隔|
|Enum|str|一组字符串|
|PickleType|任何python对象|石洞使用Pickle序列化|
|LargeBinary|str|二进制文件|


## 3. SQLAlchemy常用的列选项

|选项名|说明|
|-|-|
|primary_key|表主键|
|unique|设为true，表示这列不允许重复|
|index|设为True,表示这列建立索引|
|nullalbe|设为True,表示这列允许位空值NULL，fasle表示不允许为空|
|default|为这列默认值|



最复杂的就是多对多的关系，需要第三张表，使用db.relationship()设置。

## 4. 数据库操作

* python shell中操作

```py
	python hello.py shell
	from hello import db
	db.create_all()
```
